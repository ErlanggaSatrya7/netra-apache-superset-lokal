generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email    String? @unique
  password String?
  role     String? @default("STAFF")
}


model upload_history {
  id_upload      Int           @id @default(autoincrement())
  file_name      String        @db.VarChar
  system_name    String        @unique @db.VarChar
  status         String        @default("PENDING")
  staff_comment  String?       @db.Text   // Ini penampung pesan staff
  admin_response String?       @db.Text
  total_rows     Int           @default(0)
  uploaded_by    String?       @db.VarChar
  upload_date    DateTime?     @default(now()) @db.Timestamp(6)
  transactions   transaction[]

  @@index([status])
}

model state {
  id_state Int    @id @default(autoincrement())
  state    String @unique @db.VarChar
  region   String @db.VarChar
  city     city[]
}

model city {
  id_city     Int           @id @default(autoincrement())
  city        String        @unique @db.VarChar
  id_state    Int
  state       state         @relation(fields: [id_state], references: [id_state], onDelete: Cascade)
  transaction transaction[]
}

model product {
  id_product  Int           @id @default(autoincrement())
  product     String        @unique @db.VarChar
  transaction transaction[]
}

model retailer {
  id_retailer   Int           @id @default(autoincrement())
  retailer_id   String?       @db.VarChar
  retailer_name String        @unique @db.VarChar
  transaction   transaction[]
}

model method {
  id_method   Int           @id @default(autoincrement())
  method      String        @unique @db.VarChar
  transaction transaction[]
}

// ... datasource & generator tetap sama

model transaction {
  id_transaction   Int       @id @default(autoincrement())
  id_retailer      Int
  id_product       Int
  id_method        Int
  id_city          Int
  id_upload        Int?
  invoice_date     DateTime? @db.Date
  price_per_unit   Decimal?  @db.Decimal(18, 2)
  unit_sold        Int?
  total_sales      Decimal?  @db.Decimal(18, 2)
  operating_profit Decimal?  @db.Decimal(18, 2)
  operating_margin Decimal?  @db.Decimal(18, 4)

  // Status Utama untuk Analytics
  is_approved      Boolean?  @default(false)
  record_status    String    @default("PENDING") // PENDING, STABLE, REJECTED

  upload_history   upload_history? @relation(fields: [id_upload], references: [id_upload], onDelete: Cascade)
  city             city            @relation(fields: [id_city], references: [id_city], onDelete: NoAction)
  method           method          @relation(fields: [id_method], references: [id_method], onDelete: NoAction)
  product          product         @relation(fields: [id_product], references: [id_product], onDelete: NoAction)
  retailer         retailer        @relation(fields: [id_retailer], references: [id_retailer], onDelete: NoAction)

  @@index([id_upload])
  @@index([is_approved, record_status]) // Index komposit untuk Dashboard Admin
}